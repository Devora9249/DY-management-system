const nodemailer = require('nodemailer');
require('dotenv').config();
const { sendEmail } = require("../MailService/emailService");
const cron = require("node-cron");
const Donor = require("../models/DonorModel");

// ×”×¤×¢×œ×ª cron ×¤×¢× ×‘×™×•× ×‘×©×¢×” 02:00 ×‘×œ×™×œ×”
cron.schedule("21 00 * * *", async () => {
    console.log("ğŸ“…×‘×•×“×§ ×ª××¨×™×›×™ ×™××¨×¦×™×™×˜ ×•×™×•× ×”×•×œ×“×ª");

    const today = new Date();
    const targetDate = new Date();
    targetDate.setDate(today.getDate() + 2);

    const targetDay = targetDate.getDate();
    const targetMonth = targetDate.getMonth() + 1;
    console.log(`×‘×•×“×§ ×ª×•×¨××™× ×¢× ×™×•× ×”×•×œ×“×ª ×‘×ª××¨×™×š: ${targetDay}/${targetMonth}`);;
    
    try {
        const donors = await Donor.find();
        
        const donorsBirthday = donors.filter(donor => {
            if (!donor.birthDate) return false;
            const date = new Date(donor.birthDate);
            console.log(`donor: ${donor.name} date: ${date.getDate()}/${date.getMonth()+1}` );
            return date.getDate() === targetDay && date.getMonth()+1 === targetMonth;
        });
        console.log("donorsBirthday",donorsBirthday);
        

        if (donorsBirthday.length === 0) {
            console.log("×œ×¤×™ ×‘×“×™×§×” ×©× ×¢×¨×›×” ×›×¨×’×¢, ××™×Ÿ ×ª×•×¨××™× ×¢× ×™×•× ×”×•×œ×“×ª ×‘×¢×•×“ ×™×•××™×™×");
            return;
        }

        let emailContent = `<h2>${new Date()} :×ª×–×›×•×¨×ª ×™×•× ×”×•×œ×“×ª ×œ×ª×•×¨××™× ×”×‘××™× ×‘×¢×•×“ ×™×•××™×™× ×‘×ª××¨×™×š </h2><ul>`;
        for (const donor of donorsBirthday) {

            emailContent += `<li> ${donor.name}</li>`;
        }
        emailContent += `</ul>`;


        await sendEmail(process.env.EMAIL_RECIPIENT, "×ª×–×›×•×¨×ª ×™×•× ×”×•×œ×“×ª ×œ×ª×•×¨××™× ×‘×¢×•×“ ×™×•××™×™×", emailContent);

        console.log("âœ… ××™×™×œ ×™×•× ×”×•×œ×“×ª × ×©×œ×— ×‘×”×¦×œ×—×”");
    }
catch (error) {
        console.error("âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ ×™×•× ×”×•×œ×“×ª:", error);
    }  
 });